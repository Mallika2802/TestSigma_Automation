name: Testsigma - Run Test Plan

on:
  workflow_dispatch:

jobs:
  testsigma:
    runs-on: ubuntu-latest

    env:
      TESTSIGMA_BASE_URL: https://app.testsigma.com

    steps:
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Trigger Testsigma Execution (Test Plan)
        id: trigger
        env:
          TESTSIGMA_API_KEY: ${{ secrets.TESTSIGMA_API_KEY }}
          TESTSIGMA_TESTPLAN_ID: ${{ secrets.TESTSIGMA_TESTPLAN_ID }}
          TESTSIGMA_ENVIRONMENT_ID: ${{ secrets.TESTSIGMA_ENVIRONMENT_ID }}
        run: |
          set -e

          echo "Triggering Testsigma Test Plan..."
          echo "Test Plan ID: $TESTSIGMA_TESTPLAN_ID"
          echo "Environment ID: $TESTSIGMA_ENVIRONMENT_ID"

          PAYLOAD=$(jq -n \
            --arg executionId "$TESTSIGMA_TESTPLAN_ID" \
            --arg environmentId "$TESTSIGMA_ENVIRONMENT_ID" \
            '{executionId: $executionId, environmentId: $environmentId}')

          echo "Trigger payload:"
          echo "$PAYLOAD"

          RESPONSE=$(curl -sS -X POST "$TESTSIGMA_BASE_URL/api/v1/execution_results" \
            -H "Content-type: application/json" \
            -H "Accept: application/json" \
            -H "Authorization: Bearer $TESTSIGMA_API_KEY" \
            -d "$PAYLOAD")

          echo "Trigger response:"
          echo "$RESPONSE" | jq .

          # Run ID can appear as .id (based on your logs). We also check fallback paths.
          RUN_ID=$(echo "$RESPONSE" | jq -r '.id // .result.id // empty')

          if [ -z "$RUN_ID" ] || [ "$RUN_ID" = "null" ]; then
            echo "‚ùå ERROR: Could not parse Run ID from trigger response."
            exit 1
          fi

