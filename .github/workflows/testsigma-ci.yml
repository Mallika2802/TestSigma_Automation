name: TestSigma CI

on:
  workflow_dispatch: {}
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  testsigma:
    runs-on: ubuntu-latest

    env:
      TESTSIGMA_API_URL: "https://app.testsigma.com/api/v1"
      # Optional runtime data your Testsigma steps can read (use {{url}} in steps)
      RUNTIME_DATA_INPUT: "url=https://test.compliance-hub.trustage.com"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install jq
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq

      - name: Trigger TestSigma Execution
        id: trigger
        shell: bash
        env:
          TESTSIGMA_API_KEY: ${{ secrets.TESTSIGMA_API_KEY }}
          TESTSIGMA_TESTPLAN_ID: ${{ secrets.TESTSIGMA_TESTPLAN_ID }}
          TESTSIGMA_ENVIRONMENT_ID: ${{ secrets.TESTSIGMA_ENVIRONMENT_ID }}
          TESTSIGMA_API_URL: ${{ env.TESTSIGMA_API_URL }}
          RUNTIME_DATA_INPUT: ${{ env.RUNTIME_DATA_INPUT }}
        run: |
          echo "Triggering TestSigma execution..."

          RESPONSE=$(curl -s -X POST \
            -H "accept: application/json" \
            -H "Authorization: Bearer ${TESTSIGMA_API_KEY}" \
            -H "Content-Type: application/json" \
            "${TESTSIGMA_API_URL}/execution_results" \
            -d @- <<'JSON'
{
  "executionId": "'"${TESTSIGMA_TESTPLAN_ID}"'",
  "environmentId": "'"${TESTSIGMA_ENVIRONMENT_ID}"'",
  "runtimeData": "'"${RUNTIME_DATA_INPUT}"'"
}
JSON
          )

          echo "$RESPONSE" > response.json
          echo "Trigger response saved to response.json"

          # Extract run id across common variants
          RUN_ID=$(echo "$RESPONSE" | jq -r '.id // .runId // .data.id // .data.runId')
          if [[ -z "$RUN_ID" || "$RUN_ID" == "null" ]]; then
            echo "âŒ Could not extract RUN ID from trigger response."
            cat response.json
            exit 1
          fi

          echo "RUN_ID=$RUN_ID" >> $GITHUB_ENV
          echo "Triggered TestSigma Run ID: $RUN_ID"

      - name: Poll TestSigma Execution Status
        shell: bash
        env:
          TESTSIGMA_API_KEY: ${{ secrets.TESTSIGMA_API_KEY }}
          TESTSIGMA_API_URL: ${{ env.TESTSIGMA_API_URL }}
          RUN_ID: ${{ env.RUN_ID }}
        run: |
          echo "Polling status for run $RUN_ID"

          ATTEMPTS=72   # ~12 minutes
          SLEEP_SECS=10
          FINAL_STATUS=""

          for i in $(seq 1 $ATTEMPTS); do
            HTTP=$(curl -s -w "%{http_code}" -o status.json \
