name: TestSigma CI

on:
  workflow_dispatch: {}
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  testsigma:
    runs-on: ubuntu-latest

    env:
      TESTSIGMA_API_URL: "https://app.testsigma.com/api/v1"

    steps:
      - name: Install jq
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq

      - name: Trigger TestSigma Execution (numbers only)
        id: trigger
        shell: bash
        env:
          TESTSIGMA_API_KEY: ${{ secrets.TESTSIGMA_API_KEY }}
          TESTSIGMA_TESTPLAN_ID: ${{ secrets.TESTSIGMA_TESTPLAN_ID }}       # e.g., 4398
          TESTSIGMA_ENVIRONMENT_ID: ${{ secrets.TESTSIGMA_ENVIRONMENT_ID }} # e.g., 40
          TESTSIGMA_API_URL: ${{ env.TESTSIGMA_API_URL }}
        run: |
          echo "Triggering TestSigma execution..."

          # Build JSON with numeric IDs (endpoint expects numbers)
          payload=$(jq -n \
            --arg exec "$TESTSIGMA_TESTPLAN_ID" \
            --arg envId "$TESTSIGMA_ENVIRONMENT_ID" \
            '{executionId:($exec|tonumber), environmentId:($envId|tonumber)}')

          echo "Trigger payload:"
          echo "$payload"

          # Send request; capture HTTP code and body
          HTTP=$(curl -s -w "%{http_code}" -o response.json \
            -X POST \
            -H "accept: application/json" \
            -H "Authorization: Bearer ${TESTSIGMA_API_KEY}" \
            -H "Content-Type: application/json" \
            "${TESTSIGMA_API_URL}/execution_results" \
            -d "$payload")

          echo "HTTP=$HTTP"
          echo "Trigger response saved to response.json"
          cat response.json || true

          if [[ "$HTTP" != "200" && "$HTTP" != "201" ]]; then
            echo "‚ùå Trigger failed (HTTP $HTTP)."
            exit 1
          fi

          # Extract run id
          RUN_ID=$(jq -r '.id // .runId // .data.id // .data.runId' response.json)
          if [[ -z "$RUN_ID" || "$RUN_ID" == "null" ]]; then
