jobs:
  testsigma:
    runs-on: ubuntu-latest

    steps:
      - name: Poll TestSigma Execution Status (with debug)
        shell: bash
        env:
          TESTSIGMA_API_KEY: ${{ secrets.TESTSIGMA_API_KEY }}
          TESTSIGMA_API_URL: https://app.testsigma.com/api/v1
          RUN_ID: ${{ env.RUN_ID }}
        run: |
          echo "Polling status for run $RUN_ID"
          ATTEMPTS=72   # 12 minutes
          SLEEP_SECS=10
          FINAL_STATUS=""

          for i in $(seq 1 $ATTEMPTS); do
            HTTP=$(curl -s -w "%{http_code}" -o status.json \
              -H "Authorization: Bearer ${TESTSIGMA_API_KEY}" \
              -H "accept: application/json" \
              "${TESTSIGMA_API_URL}/execution_results/${RUN_ID}")

            if [[ "$i" -eq 1 ]]; then
              echo "----- First status.json -----"
              cat status.json || true
              echo "----------------------------"
            fi

            echo "HTTP=$HTTP"

            if [[ "$HTTP" == "401" ]]; then
              echo "❌ Unauthorized while polling. Check TESTSIGMA_API_KEY."
              exit 1
            fi

            if [[ "$HTTP" == "404" ]]; then
              echo "❌ Run not found (404). RUN_ID may be incorrect."
              cat status.json || true
              exit 1
            fi

            STATUS=$(jq -r '
              .result // .status // .state // .executionStatus // .data.status // .data.result // .data.state
            ' status.json)

            echo "[Attempt $i/$ATTEMPTS] Status = $STATUS"

            case "$STATUS" in
              SUCCESS|PASSED|COMPLETED|FAILED|ERROR|ABORTED)
                FINAL_STATUS="$STATUS"
                break
                ;;
              RUNNING|IN_PROGRESS|"")
                ;;
            esac

            sleep $SLEEP_SECS
          done

          echo "----- Final status.json -----"
          cat status.json || true
          echo "-----------------------------"

          if [[ -z "$FINAL_STATUS" ]]; then
            echo "❌ Timed out waiting for run $RUN_ID"
            exit 1
          fi

          echo "Final status: $FINAL_STATUS"

          if [[ "$FINAL_STATUS" != "SUCCESS" && "$FINAL_STATUS" != "PASSED" && "$FINAL_STATUS" != "COMPLETED" ]]; then
            echo "❌ TestSigma run failed: $FINAL_STATUS"
            exit 1
          fi

          echo "✅ TestSigma execution completed successfully."
