- name: Poll TestSigma Execution Status
        shell: bash
        env:
          TESTSIGMA_API_KEY: ${{ secrets.TESTSIGMA_API_KEY }}
          TESTSIGMA_API_URL: "https://app.testsigma.com/api/v1"
          RUN_ID: ${{ env.RUN_ID }}
        run: |
          echo "Polling status for run $RUN_ID"

          ATTEMPTS=60
          SLEEP_SECS=10
          FINAL_STATUS=""

          for ((i=1; i<=ATTEMPTS; i++)); do
            HTTP=$(curl -s -w "%{http_code}" -o status.json \
              -H "Authorization: Bearer ${TESTSIGMA_API_KEY}" \
              -H "accept: application/json" \
              "${TESTSIGMA_API_URL}/execution_results/${RUN_ID}")

            STATUS=$(jq -r '.result // .status // .state // .executionStatus // .data.status // .data.result // .data.state' status.json)

            echo "[Attempt $i/$ATTEMPTS] HTTP=$HTTP STATUS=$STATUS"

            if [[ "$HTTP" == "401" ]]; then
              echo "❌ Unauthorized! Check your API key."
              exit 1
            fi

            if [[ "$HTTP" == "404" ]]; then
              echo "❌ Run not found! RUN_ID might be wrong."
              cat status.json || true
              exit 1
            fi

            case "$STATUS" in
              SUCCESS|PASSED|COMPLETED)
                FINAL_STATUS="$STATUS"
                break
                ;;
              FAILED|ERROR|ABORTED)
                FINAL_STATUS="$STATUS"
                break
                ;;
            esac

            sleep $SLEEP_SECS
          done

          echo "Final status JSON:"
          cat status.json || true

          if [[ -z "$FINAL_STATUS" ]]; then
            echo "❌ Timed out waiting for TestSigma run to finish"
            exit 1
          fi

          echo "Final status: $FINAL_STATUS"

          if [[ "$FINAL_STATUS" != "SUCCESS" && "$FINAL_STATUS" != "PASSED" && "$FINAL_STATUS" != "COMPLETED" ]]; then
            echo "❌ TestSigma run failed with status: $FINAL_STATUS"
            exit 1
          fi

          echo "✅ TestSigma execution completed successfully."
